version: "1"
services:
  redis-node-1:
    image: redis:6.0-alpine
    container_name: redis-node-1
#    environment:
#      CLUSTER_NODES: redis-node-1:6379,redis-node-2:6379,redis-node-3:6379
#    command: ["redis-server", "--cluster-enabled", "yes", "--cluster-config-file", "/etc/redis/nodes.conf", "--cluster-node-timeout", "5000"]
#    command: redis-server --cluster-enabled yes --cluster-node-timeout 5000 --appendonly yes
    command: redis-server
    ports:
      - "7001:6379"
    volumes:
      - redis-node-1-data:/data
  redis-node-2:
    image: redis:6.0-alpine
    container_name: redis-node-2
#    environment:
#      CLUSTER_NODES: redis-node-1:6379,redis-node-2:6379,redis-node-3:6379
#    command: ["redis-server", "--cluster-enabled", "yes", "--cluster-config-file", "/etc/redis/nodes.conf", "--cluster-node-timeout", "5000"]
#    command: redis-server --cluster-enabled yes --cluster-node-timeout 5000 --appendonly yes  --slaveof redis-node-1 7001
    command: redis-server --slaveof redis-node-1 6379    
    ports:
      - "7002:6379"
    volumes:
      - redis-node-2-data:/data
    depends_on:
      - redis-node-1
  redis-node-3:
    image: redis:6.0-alpine
    container_name: redis-node-3
#    environment:
#      CLUSTER_NODES: redis-node-1:6379,redis-node-2:6379,redis-node-3:6379
#    command: ["redis-server", "--cluster-enabled", "yes", "--cluster-config-file", "/etc/redis/nodes.conf", "--cluster-node-timeout", "5000"]
#    command: redis-server --cluster-enabled yes --cluster-node-timeout 5000 --appendonly yes  --slaveof redis-node-1 7001
    command: redis-server --slaveof redis-node-1 6379        
    ports:
      - "7003:6379"
    volumes:
      - redis-node-3-data:/data   
    depends_on:
      - redis-node-1      
  spring-boot-app:
    image: sb3-jdk17-standalone
    container_name: sb3-jdk17-standalone
    build:
      context: .
      dockerfile: Dockerfile
    depends_on:
      - redis-node-1
      - redis-node-2
      - redis-node-3
    ports:
      - 8080:8080
    environment:
      - SPRING_REDIS_ENABLED = false
      - SPRING_REDIS_HOSTS = redis-node-2:7001,redis-node-1:7002,redis-node-3:7003 
volumes:
  redis-node-1-data:
  redis-node-2-data:
  redis-node-3-data:      